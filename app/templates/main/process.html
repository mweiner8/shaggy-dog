{% extends "base.html" %}

{% block title %}Processing - Shaggy Dog{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-body p-5 text-center">
                <h2 class="mb-4">
                    <i class="fas fa-magic"></i> Transforming Your Photo
                </h2>

                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="progress" style="height: 30px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar"
                             style="width: 0%"
                             aria-valuenow="0"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            0%
                        </div>
                    </div>
                </div>

                <!-- Status Message -->
                <div id="status-message" class="alert alert-info">
                    <i class="fas fa-spinner fa-spin"></i> Initializing transformation...
                </div>

                <!-- Loading Animation -->
                <div id="loading-animation" class="my-4">
                    <i class="fas fa-dog fa-4x text-primary fa-bounce"></i>
                </div>

                <p class="text-muted">
                    This may take 1-2 minutes. Please don't close this page.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
}
.fa-bounce {
    animation: bounce 1s ease-in-out infinite;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Poll for progress updates
function checkProgress() {
    fetch('{{ url_for("main.progress") }}')
        .then(response => response.json())
        .then(data => {
            // Update progress bar
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = data.progress + '%';
            progressBar.setAttribute('aria-valuenow', data.progress);
            progressBar.textContent = data.progress + '%';

            // Update status message
            const statusMessage = document.getElementById('status-message');
            statusMessage.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + data.message;

            // Check status
            if (data.status === 'complete') {
                statusMessage.className = 'alert alert-success';
                statusMessage.innerHTML = '<i class="fas fa-check-circle"></i> ' + data.message;
                document.getElementById('loading-animation').innerHTML =
                    '<i class="fas fa-check-circle fa-4x text-success"></i>';

                // Redirect to result page
                setTimeout(() => {
                    window.location.href = '{{ url_for("main.result", transformation_id=0) }}'.replace('0', data.transformation_id);
                }, 1500);

            } else if (data.status === 'error') {
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + data.message;
                document.getElementById('loading-animation').innerHTML =
                    '<i class="fas fa-exclamation-circle fa-4x text-danger"></i>';
                progressBar.className = 'progress-bar bg-danger';

            } else {
                // Continue polling
                setTimeout(checkProgress, 2000);
            }
        })
        .catch(error => {
            console.error('Error checking progress:', error);
            setTimeout(checkProgress, 2000);
        });
}

// Start polling when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(checkProgress, 1000);
});
</script>
{% endblock %}